<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Credencial</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body {
    margin: 0;
    background: #ccc;
    font-family: 'Roboto', Arial, sans-serif;
}

/* CONTENEDOR */
#viewport {
    width: 100vw;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* LIENZO */
#credencial {
    position: relative;
    width: min(90vw, 360px);
    aspect-ratio: 53.98 / 85.6;
    background: #fff;
    box-shadow: 0 0 25px rgba(0,0,0,.35);
    overflow: hidden;
}

/* ===== FONDO (SIEMPRE ABAJO) ===== */
#capa-fondo {
    position: absolute;
    inset: 0;
    z-index: 0;
}
#capa-fondo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* FOTO */
#capa-foto {
    position: absolute;
    top: 16%;
    left: 6%;
    width: 88%;
    height: 26%;
    z-index: 1;
}
#capa-foto img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
}

/* QR */
#capa-qr {
    position: absolute;
    bottom: 6%;
    left: 6%;
    width: 32%;
    aspect-ratio: 1;
    z-index: 2;
}
#capa-qr img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
}

/* TEXTO */
#capa-texto {
    position: absolute;
    top: 46%;
    width: 100%;
    padding: 0 6%;
    text-align: center;
    z-index: 3;
}
#capa-texto div {
    font-weight: 700;
    font-size: 1.1rem;
}

/* FECHAS */
#licenciatura {
    position: absolute;
    bottom: 6%;
    right: 6%;
    width: 38%;
    text-align: center;
    z-index: 3;
}
#fechas {
    display: flex;
    justify-content: center;
    gap: 8px;
}
.cuadro {
    width: 36px;
    height: 36px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* BOTÓN */
#btn-pdf {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 14px 22px;
    font-weight: bold;
    z-index: 999;
}

/* IMPRESIÓN */
@media print {
    html, body {
        width: 53.98mm;
        height: 85.6mm;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    #credencial {
        width: 53.98mm !important;
        height: 85.6mm !important;
        box-shadow: none;
        page-break-inside: avoid;
    }

    #btn-pdf {
        display: none;
    }
}
</style>
</head>

<body>

<button id="btn-pdf">Descargar PDF</button>

<div id="viewport">
<div id="credencial">

    <div id="capa-fondo"><img id="fondo" crossorigin="anonymous"></div>
    <div id="capa-foto"><img id="foto" crossorigin="anonymous"></div>
    <div id="capa-qr"><img id="qr" crossorigin="anonymous"></div>

    <div id="capa-texto">
        <div id="nombre"></div>
        <div id="id"></div>
        <div id="carrera"></div>
    </div>

    <div id="licenciatura">
        <div id="fechas">
            <div class="cuadro" id="ingreso"></div>
            <div class="cuadro" id="egreso"></div>
        </div>
    </div>

</div>
</div>

<script>
let nombreArchivoPDF = "credencial";

/* CSV */
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vR7VpRlusZqfiI-WB16JvLtLpX-kkCFZWiKgTMQzW35p_tfOGxY_tpQRW56XnAOdKIA_1F-4uSuX47P/pub?gid=970287024&single=true&output=csv";

const matriculaBuscar = new URLSearchParams(location.search).get("matricula");

function parseCSV(t) {
    return t.trim().split("\n").map(f => f.split(",").map(v => v.replace(/\"/g,"").trim()));
}

async function cargarDatos() {
    const resp = await fetch(CSV_URL);
    const data = parseCSV(await resp.text());
    const headers = data[0];
    const fila = data.slice(1).find(r => r[headers.indexOf("ID9DIG")] === matriculaBuscar);
    if (!fila) return;

    const get = c => fila[headers.indexOf(c)];

    fondo.src = get("Fondo");
    foto.src  = get("Foto");
    qr.src    = get("QR");

    nombre.textContent  = get("Nombre");
    id.textContent      = "ID: " + get("ID9DIG");
    carrera.textContent = get("Carrera");

    ingreso.textContent = get("AñoIngreso");
    egreso.textContent  = get("AñoEgreso");

    nombreArchivoPDF = get("nombre cred");
}
cargarDatos();

/* PDF – 1 PÁGINA */
btn-pdf.onclick = () => {
    html2pdf().set({
        margin: 0,
        filename: `${nombreArchivoPDF}.pdf`,
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 3, useCORS: true },
        jsPDF: {
            unit: 'mm',
            format: [53.98, 85.6],
            orientation: 'portrait'
        }
    }).from(credencial).save();
};
</script>

</body>
</html>
